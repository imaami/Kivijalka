<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>le WebCocquettes</title>
</head>

<body>

<style>
#thumb { border: 10px dashed #ccc; width: 300px; min-height: 300px; margin: 20px auto; }
#thumb.hover { border: 10px dashed #0c0; }
#thumb img { display: block; margin: 10px auto; }
#thumb p { margin: 10px; font-size: 14px; }
</style>

  <div style="width:100%;position:relative">
    <div id="thumb" style="margin:0px auto;width:auto;height:auto;display:table;float:left">
      <canvas id="thumbCanvas" width="640" height="512" style="border:0px solid #000000;">
      </canvas>
    </div>
    <div id="bannerQueue" style="margin:0px auto;width:auto;height:auto;display:table:float:left">
      <img src="/usr/share/kivijalka/banners/banner.png" alt="banner" />
    </div>
  </div>

<script>
var urlCreator = window.URL || window.webkitURL;
var thumb = document.getElementById('thumb');
var bq = document.getElementById('bannerQueue');

var dragging = false;
var dragArray;
var dragImg = new Image();
dragImg.onload = function(e) {
	console.log('dragImg.onload');
	document.body.appendChild(this);
	console.log(this.width + "x" + this.height);
};

var clearCanvas = function(ctx, w, h) {
	ctx.clearRect(0, 0, w, h);
};

var resizeCanvas = function(c, w, h) {
	c.width = w;
	c.height = h;
};

var socket_recv_thumb = function(data) {
	var blob = new Blob([data],{type: "image/png"});
	var img = new Image();

	img.onload = function (e) {
		var cnv = document.getElementById("thumbCanvas");
		var ctx = cnv.getContext("2d");
		resizeCanvas(cnv, img.width, img.height);
		ctx.drawImage(img, 0, 0);
		window.URL.revokeObjectURL(img.src);
		img = null;
	};

	img.onerror = img.onabort = function () {
		img = null;
	};

	img.src = window.URL.createObjectURL(blob);
};

var socket_addr = 'ws://127.0.0.1:8001/';
var socket;

var socket_init_handshake = function() {
	socket.send("71bf2d31e9e4e15c");
};

var socket_opened = function() {
	console.log('Connected');
	socket_init_handshake();
};

var socket_reconnect = function() {
	if (socket.readyState == 3) {
		// CLOSED
		new_socket();
	} else if (socket.readyState == 0
	           || socket.readyState == 2) {
		// CONNECTING or CLOSING
		setTimeout(socket_reconnect(), 4000);
	} else {
		// OPEN
	}
};

var socket_closed = function() {
	console.log('Disconnected; will try to reconnect soon...');
	socket_reconnect();
};

var socket_error = function() {
	console.log('WebFuckit');
};

var socket_message = function(ev) {
	if (typeof ev.data === "string") {
		socket_recv_meta(ev.data);
	} else if (ev.data instanceof ArrayBuffer
	           || ev.data instanceof Blob) {
		socket_recv_thumb(ev.data);
	}
};

// receive handshake response from server
var socket_recv_handshake = function(e) {
	if (typeof e.data === "string") {
		console.log(e.data);
		var msg = JSON.parse(e.data);
		if (msg.type === "c9f82f30e6a00db0") {
			socket.onmessage = socket_message;
			console.log('Handshake response at ' + msg.ts);
			return;
		}
	}
	console.log('Wrong handshake');
	socket.close();
	socket = null;
};

var new_socket = function() {
	socket = new WebSocket(socket_addr);
	socket.binaryType = "arraybuffer";
	socket.onopen = socket_opened;
	socket.onclose = socket_closed;
	socket.onerror = socket_error;
	socket.onmessage = socket_recv_handshake;
};

var enqueue_file = function(file) {
	console.log('enqueue_file');

	if (file.type.match('image.*')) {
		var reader = new FileReader();

		reader.onload = function(e) {
			var img = new Image();
			img.src = reader.result;
			bq.appendChild(img);
		};

		reader.readAsDataURL(file);
	}
}

var drag_file = function(file) {
	if (!dragging) {
		dragging = true;

		console.log('drag_file');

		if (file.type === 'image/png') {
			var reader = new FileReader();

			reader.onload = function (e) {
				console.log('drag_file.reader.onload');
				dragArray = new Uint8Array(e.target.result);
				var blob = new Blob([dragArray], {type: "image/png"});
				dragImg.src = urlCreator.createObjectURL(blob);
			};

			reader.readAsArrayBuffer(file);
		}
	}
}

var upload_file = function(file) {
	console.log('upload_file');

	if (file.type === 'image/png') {
		var reader = new FileReader();
		var bytearray;

		reader.onload = function (e) {
			console.log('upload_file.reader.onload');
			bytearray = new Uint8Array(e.target.result);
			socket.send(bytearray.buffer);
		};

		reader.readAsArrayBuffer(file);
	}
}

bq.ondrop = function (e) {
//	console.log('bq.ondrop');
	e.preventDefault();
	var dt = e.dataTransfer;

	var types = dt.types;
	for (var i = 0; i < types.length; ++i) {
		if (types[i] === 'text/uri-list') {
			console.log(types[i] + "=" + e.dataTransfer.getData('text/uri-list').split("\n"));
		} else {
			console.log(types[i]);
		}
	}

	var files = dt.files;
	for (var i = 0; i < files.length; ++i) {
		enqueue_file (files[i]);
	}
};

bq.ondragover = function (e) {
//	console.log('bq.ondragover');
	e.preventDefault();
	return false;
};

bq.ondragleave = function () {
//	console.log('bq.ondragleave');
};

bq.ondragend = function () {
//	console.log('bq.ondragend');
};

bq.ondragenter = function (e) {
//	console.log('bq.ondragenter');
};

bq.ondragstart = function (e) {
//	console.log('bq.ondragstart');
};

thumb.ondragstart = function (e) {
	console.log('thumb.ondragstart');
};

thumb.ondragenter = function (e) {
	console.log('thumb.ondragenter');
	e.preventDefault();
	drag_file(e.dataTransfer.files[0]);
	return false;
};

thumb.ondragover = function (e) {
	console.log('thumb.ondragover');
	this.className = 'hover';
	e.preventDefault();
	drag_file(e.dataTransfer.files[0]);
	return false;
};

thumb.ondragleave = function () {
	console.log('thumb.ondragleave');
	this.className = '';
	dragging = false;
	return false;
};

thumb.ondragend = function () {
	console.log('thumb.ondragend');
	this.className = '';
	dragging = false;
	return false;
};

thumb.ondrop = function (e) {
	console.log('thumb.ondrop');
	this.className = '';
	e.preventDefault();

	var types = e.dataTransfer.types;
	for (var i = 0; i < types.length; ++i) {
		if (types[i] === 'text/uri-list') {
			console.log(types[i] + "=" + e.dataTransfer.getData('text/uri-list').split("\n"));
		} else {
			console.log(types[i]);
		}
	}

//	if (socket.readyState == 1) {
//		upload_file(e.dataTransfer.files[0]);
//	} else {
//		console.log('Socket not open');
//	}

	dragging = false;
};

new_socket();

</script>
</body>
</html>
