<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>le WebCocquettes</title>
  <script type="text/javascript" src="rusha.js"></script>
</head>

<body>

<!--<style>
#thumb { border: 10px dashed #ccc; width: 300px; min-height: 300px; margin: 20px auto; }
#thumb.hover { border: 10px dashed #0c0; }
#thumb img { display: block; margin: 10px auto; }
#thumb p { margin: 10px; font-size: 14px; }
</style>-->

  <div style="width:100%;position:relative">
    <div id="thumb" style="margin:0px auto;width:auto;height:auto;display:table;float:left">
      <canvas id="thumbCanvas"
              style="z-index: 1;
                     position: absolute;
                     left: 0px;
                     top: 0px;
                     border:0px solid #000000;">
      </canvas>
      <canvas id="dragCanvas"
              style="z-index: 2;
                     position: absolute;
                     left: 0px;
                     top: 0px;
                     border:0px solid #000000;">
      </canvas>
    </div>
    <div id="bannerQueue" style="margin:0px auto;width:auto;height:auto;display:table:float:left">
<!--  <img src="/usr/share/kivijalka/banners/banner.png" alt="banner" />-->
      <p id="debug"></p>
    </div>
  </div>

<script>
var urlCreator = window.URL || window.webkitURL;
var thumb = document.getElementById('thumb');
var thumb_canvas = document.getElementById('thumbCanvas');
var thumb_ctx = thumb_canvas.getContext("2d");
var thumb_width = 0;
var thumb_height = 0;
var thumb_scaling = 1.0;

/* infoscreen dimensions */
var screen_width = 0;
var screen_height = 0;

var bq = document.getElementById('bannerQueue');
var dbg = document.getElementById('debug');

var drag_canvas = document.getElementById('dragCanvas');
var drag_ctx = drag_canvas.getContext("2d");
var dragging = false;
var dragArray;

var drag_img = new Image();
var drag_img_width = 0;
var drag_img_height = 0;
var drag_img_scaled_width = 0;
var drag_img_scaled_height = 0;
var drag_img_x_offset = 0;
var drag_img_y_offset = 0;

drag_img.onload = function(e) {
	drag_img_width = this.width;
	drag_img_height = this.height;
	drag_img_scaled_width = drag_img_width * thumb_scaling;
	drag_img_scaled_height = drag_img_height * thumb_scaling;
	drag_img_x_offset = -Math.round(drag_img_scaled_width / 2.0);
	drag_img_y_offset = -Math.round(drag_img_scaled_height / 2.0);

	console.log('drag_img_width=' + drag_img_width);
	console.log('drag_img_height=' + drag_img_height);
	console.log('drag_img_scaled_width=' + drag_img_scaled_width);
	console.log('drag_img_scaled_height=' + drag_img_scaled_height);
	console.log('drag_img_x_offset=' + drag_img_x_offset);
	console.log('drag_img_y_offset=' + drag_img_y_offset);

//	console.log('drag_img.onload: ' + this.width + 'x' + this.height);
//	document.body.appendChild(this);
};

var drag_canvas_draw = function(x, y) {
	drag_ctx.clearRect(0, 0, thumb_width, thumb_height);
	drag_ctx.fillStyle = "#4488EE";
	drag_ctx.beginPath();
	drag_ctx.rect(x + drag_img_x_offset, y + drag_img_y_offset,
	              drag_img_scaled_width, drag_img_scaled_height);
	drag_ctx.closePath();
	drag_ctx.fill();
};

var scale2D = function(w, h, f) {
	return {
		width: w * f,
		height: h * f
	};
};

var clearCanvas = function(ctx, w, h) {
	ctx.clearRect(0, 0, w, h);
};

var thumb_resize = function(w, h) {
	if (thumb_width != w || thumb_height != h) {
	        thumb_width = w;
		thumb_height = h;
		thumb_scaling = thumb_width / screen_width;
		thumb_canvas.width = thumb_width;
		thumb_canvas.height = thumb_height;
		drag_canvas.width = thumb_width;
		drag_canvas.height = thumb_height;
	}
};

var socket_recv_thumb = function(data) {
	var blob = new Blob([data],{type: "image/png"});
	var img = new Image();

	img.onload = function (e) {
		thumb_resize(img.width, img.height);
		thumb_ctx.drawImage(img, 0, 0);
		urlCreator.revokeObjectURL(img.src);
		img = null;
	};

	img.onerror = img.onabort = function () {
		img = null;
	};

	img.src = urlCreator.createObjectURL(blob);
};

var socket_addr = 'ws://127.0.0.1:8001/';
var socket;

var socket_init_handshake = function() {
	socket.send("71bf2d31e9e4e15c");
};

var socket_opened = function() {
	console.log('Connected');
	socket_init_handshake();
};

var socket_reconnect = function() {
	if (socket.readyState == 3) {
		// CLOSED
		new_socket();
	} else if (socket.readyState == 0
	           || socket.readyState == 2) {
		// CONNECTING or CLOSING
		setTimeout(socket_reconnect(), 4000);
	} else {
		// OPEN
	}
};

var socket_closed = function() {
	console.log('Disconnected; will try to reconnect soon...');
	socket_reconnect();
};

var socket_error = function() {
	console.log('WebFuckit');
};

var socket_recv_meta = function(msg) {
	console.log('socket_recv_meta');
};

var socket_recv_msg = function(e) {
	if (typeof e.data === "string") {
		socket_recv_meta(JSON.parse(e.data));
	} else if (e.data instanceof ArrayBuffer
	           || e.data instanceof Blob) {
		socket_recv_thumb(e.data);
	}
};

// receive handshake response from server
var socket_recv_handshake = function(e) {
	if (typeof e.data === "string") {
		console.log(e.data);
		var msg = JSON.parse(e.data);
		if (msg.type === "c9f82f30e6a00db0") {
			socket.onmessage = socket_recv_msg;
			console.log('Handshake response at ' + msg.ts);
			screen_width = msg.w;
			screen_height = msg.h;
			thumb_resize(msg.tw, msg.th);
			return;
		}
	}
	console.log('Wrong handshake');
	socket.close();
	socket = null;
};

var new_socket = function() {
	socket = new WebSocket(socket_addr);
	socket.binaryType = "arraybuffer";
	socket.onopen = socket_opened;
	socket.onclose = socket_closed;
	socket.onerror = socket_error;
	socket.onmessage = socket_recv_handshake;
};

var enqueue_file = function(file) {
	console.log('enqueue_file');

	if (file.type.match('image.*')) {
		var reader = new FileReader();

		reader.onload = function(e) {
			var img = new Image();
			img.src = reader.result;
			bq.appendChild(img);
		};

		reader.readAsDataURL(file);
	}
};

/**
 * Return Git-type SHA1 digest of Uint8array input data.
 */
var git_hash = function(data) {
	var dataLen = data.length;
	var dLenStr = dataLen.toString();
	var lStrLen = dLenStr.length;
	var headLen = lStrLen + 6;

	var tmp = new Uint8Array(headLen + dataLen);

	tmp[0] = 98; tmp[1] = 108;
	tmp[2] = 111; tmp[3] = 98;
	tmp[4] = 32;
	for (var i = 0; i < lStrLen; ++i) {
		tmp[5+i] = dLenStr.charCodeAt(i);
	}
	tmp[headLen-1] = 0;
	tmp.set(new Uint8Array(data), headLen);

	return (new Rusha()).digestFromBuffer(tmp);
};

var drag_file = function(file) {
	if (file !== undefined && !dragging) {
		dragging = true;

		console.log('drag_file');

		if (file.type === 'image/png') {
			var reader = new FileReader();

			reader.onload = function (e) {
				dragArray = new Uint8Array(e.target.result);
				console.log('drag_file.reader.onload: git_hash: '
				            + git_hash(dragArray));
				var blob = new Blob([dragArray], {type: "image/png"});
				drag_img.src = urlCreator.createObjectURL(blob);
			};

			reader.readAsArrayBuffer(file);
		}
	}
};

var upload_file = function(file) {
	console.log('upload_file');

	if (file.type === 'image/png') {
		var reader = new FileReader();
		var bytearray;

		reader.onload = function (e) {
			console.log('upload_file.reader.onload');
			bytearray = new Uint8Array(e.target.result);
			socket.send(bytearray.buffer);
		};

		reader.readAsArrayBuffer(file);
	}
}

bq.ondrop = function (e) {
//	console.log('bq.ondrop');
	e.preventDefault();
	var dt = e.dataTransfer;

	var types = dt.types;
	for (var i = 0; i < types.length; ++i) {
		if (types[i] === 'text/uri-list') {
			console.log(types[i] + "=" + e.dataTransfer.getData('text/uri-list').split("\n"));
		} else {
			console.log(types[i]);
		}
	}

	var files = dt.files;
	for (var i = 0; i < files.length; ++i) {
		enqueue_file (files[i]);
	}
};

bq.ondragover = function (e) {
//	console.log('bq.ondragover');
	e.preventDefault();
	return false;
};

bq.ondragleave = function () {
//	console.log('bq.ondragleave');
};

bq.ondragend = function () {
//	console.log('bq.ondragend');
};

bq.ondragenter = function (e) {
//	console.log('bq.ondragenter');
};

bq.ondragstart = function (e) {
//	console.log('bq.ondragstart');
};

thumb.ondragstart = function (e) {
	console.log('thumb.ondragstart');
};

var thumb_mousemove = function(e) {
	var rect = thumb_canvas.getBoundingClientRect();
	var x = e.clientX - rect.left;
	var y = e.clientY - rect.top;
	dbg.innerHTML = '&nbsp;&nbsp;{ ' + x + ', ' + y + ' }';
	drag_canvas_draw(x, y);
};

var thumb_mouseout = function() {
	dbg.innerHTML = "";
};

thumb.onmousemove = thumb_mousemove;
thumb.onmouseout = thumb_mouseout;

thumb.ondragenter = function (e) {
	console.log('thumb.ondragenter');
	e.preventDefault();
	drag_file(e.dataTransfer.files[0]);
	return false;
};

thumb.ondragover = function (e) {
	this.className = 'hover';
	e.preventDefault();
	thumb_mousemove(e);
	drag_file(e.dataTransfer.files[0]);
	return false;
};

thumb.ondragleave = function () {
	console.log('thumb.ondragleave');
	this.className = '';
	dragging = false;
	thumb_mouseout();
	return false;
};

thumb.ondragend = function () {
	console.log('thumb.ondragend');
	this.className = '';
	dragging = false;
	return false;
};

thumb.ondrop = function (e) {
	console.log('thumb.ondrop');
	this.className = '';
	e.preventDefault();

	var types = e.dataTransfer.types;
	for (var i = 0; i < types.length; ++i) {
		if (types[i] === 'text/uri-list') {
			console.log(types[i] + "=" + e.dataTransfer.getData('text/uri-list').split("\n"));
		} else {
			console.log(types[i]);
		}
	}

	if (socket.readyState == 1) {
		upload_file(e.dataTransfer.files[0]);
	} else {
		console.log('Socket not open');
	}

	dragging = false;
};

new_socket();

</script>
</body>
</html>
